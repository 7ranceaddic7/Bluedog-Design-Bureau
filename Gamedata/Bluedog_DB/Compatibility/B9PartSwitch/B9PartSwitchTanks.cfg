//
// Thanks Nertea
//


@PART[bluedog*,Bluedog*]:HAS[@RESOURCE[Ore],!MODULE[ModuleB9PartSwitch],!MODULE[WBIResourceSwitcher]]:NEEDS[B9PartSwitch]:FOR[Bluedog_DB_1]
{
	%tank_volume = #$RESOURCE[Ore]/maxAmount$
	
	%fuel_cost = #$RESOURCE[Ore]/amount$
	@fuel_cost *= #$@RESOURCE_DEFINITION[Ore]/unitCost$
	
	%tank_mass = #$tank_volume$
	@tank_mass *= #$@B9_TANK_TYPE[bdbSupplyOre]/tankMass$
	
	extraMass = #$mass$
	@extraMass -= #$tank_mass$
	
	tank_cost = #$tank_volume$
	@tank_cost *= #$@B9_TANK_TYPE[bdbSupplyOre]/tankCost$
	
	tank_plus_fuel_cost = #$tank_cost$
	@tank_plus_fuel_cost += #$fuel_cost$
	
	extraCost = #$cost$
	@extraCost -= #$tank_plus_fuel_cost$
	
	//@cost = #$tank_plus_fuel_cost$
	
	fuelPctFill = #$RESOURCE[Ore]/amount$
	@fuelPctFill /= #$RESOURCE[Ore]/maxAmount$
	@fuelPctFill *= 100
	
	!RESOURCE[Ore] {}
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Cargo
		baseVolume = #$../tank_volume$
		SUBTYPE
		{
			name = Ore
			tankType = bdbSupplyOre
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
	}
}

// Service Modules. Need special handling for fuel + monoprop.
// Bluedog_DB/Parts/Apollo/bluedog_Apollo_Block2_ServiceModule/bluedog_Apollo_Block2_ServiceModule
// Bluedog_DB/Parts/Apollo/bluedog_Apollo_Block3_ServiceModule/bluedog_Apollo_Block3_ServiceModule
// Bluedog_DB/Parts/Apollo/bluedog_LEM_Ascent_Cockpit/bluedog_LEM_Ascent_Cockpit
// Bluedog_DB/Parts/Delta/bluedog_DeltaK_LowerTank/bluedog_DeltaK_LowerTank
// Bluedog_DB/Parts/Gemini/bluedog_Gemini_MalhenaSM/bluedog_Gemini_MalhenaSM
// Bluedog_DB/Parts/Gemini/bluedog_Gemini_ResupplyCapsule/bluedog_Gemini_Resupply_Capsule
// Bluedog_DB/Parts/Titan/bluedog_Titan_TranstageTank/bluedog_Titan_TranstageTank
// Bluedog_DB/Parts/Vega/bluedog_Vega_EngineMount/bluedog_Vega_EngineMount

@PART[bluedog*,Bluedog*]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],@RESOURCE[MonoPropellant],!MODULE[ModuleEngines*],!MODULE[ModuleB9PartSwitch],!MODULE[WBIResourceSwitcher]]:NEEDS[B9PartSwitch]:FOR[Bluedog_DB_1]
{
	%tank_volume = #$RESOURCE[LiquidFuel]/maxAmount$
	@tank_volume += #$RESOURCE[Oxidizer]/maxAmount$
	@tank_volume += #$RESOURCE[MonoPropellant]/maxAmount$
	
	extraMass = 0.0
	
	// Service Modules.
	// No cost or mass adjustments on tank switch.
	// Final mix will be 80% fuel, 20% mp.
	
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}
	!RESOURCE[MonoPropellant] {}
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Fuel
		baseVolume = #$../tank_volume$
		SUBTYPE
		{
			name = LF/O
			tankType = bdbSm80pctLFOX
			addedMass = 0
			addedCost = 0
		}
		SUBTYPE
		{
			name = LH2/O
			tankType = bdbSm80pctLH2O
			addedMass = 0
			addedCost = 0
		}
		SUBTYPE
		{
			name = MonoProp
			tankType = bdbSmMP
			addedMass = 0
			addedCost = 0
		}
	}
}

// Service modules. Some need 90% fuel, 10% mp.
@PART[bluedog_LEM_Ascent_Cockpit]:HAS[@MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch]:FOR[Bluedog_DB_1]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			@tankType = bdbSm90pctLFOX
		}
		@SUBTYPE,1
		{
			@tankType = bdbSm90pctLH2O
		}
	}
}

// Just relabel
@PART[bluedog_Vega_EngineMount]:HAS[#bdbSystemScale[>0],~bdbMassAdjusted[*]]:FOR[zzzBluedog_DB_3]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			@name = Balloon
		}
	}
}

// Balloon tanks

@PART[bluedog_agenaLongTank,bluedog_atlas1*Tank,bluedog_atlasFairingAdapterTank,bluedog_Vega*]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!RESOURCE[MonoPropellant],!MODULE[ModuleEngines*],!MODULE[ModuleB9PartSwitch],!MODULE[WBIResourceSwitcher]]:NEEDS[B9PartSwitch]:FOR[Bluedog_DB_1]
{
	%tank_volume = #$RESOURCE[LiquidFuel]/maxAmount$
	@tank_volume += #$RESOURCE[Oxidizer]/maxAmount$
	
	%fuel_cost = #$RESOURCE[LiquidFuel]/amount$
	@fuel_cost *= #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	%ox_cost = #$RESOURCE[Oxidizer]/amount$
	@ox_cost *= #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@fuel_cost += #$ox_cost$
	
	%tank_mass = #$tank_volume$
	@tank_mass *= #$@B9_TANK_TYPE[bdbBalloon]/tankMass$
	
	extraMass = #$mass$
	@extraMass -= #$tank_mass$
	
	tank_cost = #$tank_volume$
	@tank_cost *= #$@B9_TANK_TYPE[bdbBalloon]/tankCost$
	
	tank_plus_fuel_cost = #$tank_cost$
	@tank_plus_fuel_cost += #$fuel_cost$
	
	extraCost = #$cost$
	@extraCost -= #$tank_plus_fuel_cost$
	
	//@cost = #$tank_plus_fuel_cost$
	
	fuelPctFill = #$RESOURCE[Oxidizer]/amount$
	@fuelPctFill /= #$RESOURCE[Oxidizer]/maxAmount$
	@fuelPctFill *= 100
	
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Fuel
		baseVolume = #$../tank_volume$
		SUBTYPE
		{
			name = Balloon
			tankType = bdbBalloon
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
		SUBTYPE
		{
			name = LH2/O
			tankType = bdbLH2O
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
		SUBTYPE
		{
			name = MonoProp
			tankType = bdbMonoProp
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
	}
}

// Regular tanks

@PART[bluedog*,Bluedog*]:HAS[@RESOURCE[LiquidFuel],@RESOURCE[Oxidizer],!RESOURCE[MonoPropellant],!MODULE[ModuleEngines*],!MODULE[ModuleB9PartSwitch],!MODULE[WBIResourceSwitcher]]:NEEDS[B9PartSwitch]:FOR[Bluedog_DB_1]
{
	%tank_volume = #$RESOURCE[LiquidFuel]/maxAmount$
	@tank_volume += #$RESOURCE[Oxidizer]/maxAmount$
	
	%fuel_cost = #$RESOURCE[LiquidFuel]/amount$
	@fuel_cost *= #$@RESOURCE_DEFINITION[LiquidFuel]/unitCost$
	%ox_cost = #$RESOURCE[Oxidizer]/amount$
	@ox_cost *= #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@fuel_cost += #$ox_cost$
	
	%tank_mass = #$tank_volume$
	@tank_mass *= #$@B9_TANK_TYPE[bdbLFOX]/tankMass$
	
	extraMass = #$mass$
	@extraMass -= #$tank_mass$
	
	tank_cost = #$tank_volume$
	@tank_cost *= #$@B9_TANK_TYPE[bdbLFOX]/tankCost$
	
	tank_plus_fuel_cost = #$tank_cost$
	@tank_plus_fuel_cost += #$fuel_cost$
	
	extraCost = #$cost$
	@extraCost -= #$tank_plus_fuel_cost$
	
	//@cost = #$tank_plus_fuel_cost$
	
	fuelPctFill = #$RESOURCE[Oxidizer]/amount$
	@fuelPctFill /= #$RESOURCE[Oxidizer]/maxAmount$
	@fuelPctFill *= 100
	
	!RESOURCE[LiquidFuel] {}
	!RESOURCE[Oxidizer] {}
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Fuel
		baseVolume = #$../tank_volume$
		SUBTYPE
		{
			name = LF/O
			tankType = bdbLFOX
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
		SUBTYPE
		{
			name = LH2/O
			tankType = bdbLH2O
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
		SUBTYPE
		{
			name = MonoProp
			tankType = bdbMonoProp
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[@RESOURCE[LqdHydrogen],@RESOURCE[Oxidizer],!RESOURCE[MonoPropellant],!MODULE[ModuleEngines*],!MODULE[ModuleB9PartSwitch],!MODULE[WBIResourceSwitcher]]:NEEDS[B9PartSwitch]:FOR[Bluedog_DB_1]
{
	%tank_volume = #$RESOURCE[LqdHydrogen]/maxAmount$
	@tank_volume /= 5
	@tank_volume += #$RESOURCE[Oxidizer]/maxAmount$
	
	%fuel_cost = #$RESOURCE[LqdHydrogen]/amount$
	@fuel_cost *= #$@RESOURCE_DEFINITION[LqdHydrogen]/unitCost$
	%ox_cost = #$RESOURCE[Oxidizer]/amount$
	@ox_cost *= #$@RESOURCE_DEFINITION[Oxidizer]/unitCost$
	@fuel_cost += #$ox_cost$
	
	%tank_mass = #$tank_volume$
	@tank_mass *= #$@B9_TANK_TYPE[bdbLH2O]/tankMass$
	
	extraMass = #$mass$
	@extraMass -= #$tank_mass$
	
	tank_cost = #$tank_volume$
	@tank_cost *= #$@B9_TANK_TYPE[bdbLH2O]/tankCost$
	
	tank_plus_fuel_cost = #$tank_cost$
	@tank_plus_fuel_cost += #$fuel_cost$
	
	extraCost = #$cost$
	@extraCost -= #$tank_plus_fuel_cost$
	
	//@cost = #$tank_plus_fuel_cost$
	
	fuelPctFill = #$RESOURCE[Oxidizer]/amount$
	@fuelPctFill /= #$RESOURCE[Oxidizer]/maxAmount$
	@fuelPctFill *= 100
	
	!RESOURCE[LqdHydrogen] {}
	!RESOURCE[Oxidizer] {}
	
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = fuelSwitch
		switcherDescription = Fuel
		baseVolume = #$../tank_volume$
		SUBTYPE
		{
			name = LH2/O
			tankType = bdbLH2O
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
		SUBTYPE
		{
			name = LF/O
			tankType = bdbLFOX
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
		SUBTYPE
		{
			name = MonoProp
			tankType = bdbMonoProp
			addedMass = #$../../tank_mass$
			@addedMass *= -1
			addedCost = #$../../tank_plus_fuel_cost$
			@addedCost *= -1
			percentFilled = #$../../fuelPctFill$
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[@RESOURCE[LqdHydrogen],!MODULE[ModuleBdbBoiloff]]:FOR[Bluedog_DB_8]
{
	MODULE
	{
		name = ModuleBdbBoiloff
		CRYOGENICRESOURCE
		{
			name = LqdHydrogen
			boiloffRate = 8
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[ModuleB9PartSwitch],!MODULE[ModuleBdbBoiloff]]:FOR[Bluedog_DB_8]
{
	MODULE
	{
		name = ModuleBdbBoiloff
		CRYOGENICRESOURCE
		{
			name = LqdHydrogen
			boiloffRate = 8
		}
	}
}

@PART[bluedog*,Bluedog*]:HAS[@MODULE[WBIResourceSwitcher],!MODULE[ModuleBdbBoiloff]]:FOR[Bluedog_DB_8]
{
	MODULE
	{
		name = ModuleBdbBoiloff
		CRYOGENICRESOURCE
		{
			name = LqdHydrogen
			boiloffRate = 8
		}
	}
}

@PART[bluedog*,Bluedog*]:FOR[zzzBluedog_DB_9]
{
	!tank_volume = delete
	!fuel_cost = delete
	!ox_cost = delete
	!mp_cost = delete
	!tank_mass = delete
	!extraCost = delete
	!tank_plus_fuel_cost = delete
	!extraMass = delete
	!fuelPctFill = delete
}

@PART[bluedog*,Bluedog*]:AFTER[zzz_CryoTanks]
{
	!MODULE[ModuleB9PartSwitch]:HAS[#switcherDescription[Tank?Type]] {} // CryoTanks uses "Tank Type", we use "Fuel"
	!MODULE[ModuleCryoTank] {}
}
